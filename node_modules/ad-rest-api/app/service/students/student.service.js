//common declaration
let dbservice = require("../database/db.service");


//page lavel declaration
let waterfall = require("async-waterfall");
let studentsModal = require("../../models/students/student.modal");

let sliderService = {
  postStudent: insertStudentAndEvent,
  updateStudent: post,
  getByAdhar:getstudentByAdhar
};

module.exports = sliderService;

function post(req, result) {
  console.log("post event in service :: ", [req.body]);

  let sqlQuery = "";
  studentsModal.body = req.body;
  var thisModal = studentsModal.body;

  let params = [
    thisModal.firstNameStudents,
    thisModal.middleNameStudents,
    thisModal.lastNameStudents,
    thisModal.emailStudents,
    thisModal.adharNoStudents,
    thisModal.mobileNoStudents,
    thisModal.genderStudents,
    thisModal.dobStudents,
    thisModal.coachNameStudents,
    thisModal.coachMoNoStudents,
    thisModal.addressStudents,
    thisModal.imageStudents
  ];
  waterfall(
    [
      function (callback) {
        if (thisModal.idEventSection && thisModal.idEventSection > 0) {
          dbservice.executeSql(
            "SELECT * FROM `students` WHERE `idStudents` = ?",
            [thisModal.idStudents],
            function (err, res) {
              if (err) {
                callback(null, err);
              } else {
                sqlQuery = "UPDATE `students`"
                sqlQuery += " SET `firstNameStudents`=?,`middleNameStudents`=?,`lastNameStudents`=?,`emailStudents`=?,"
                sqlQuery += " `adharNoStudents`=?,`mobileNoStudents`=?,`genderStudents`=?,`dobStudents`=?,"
                sqlQuery += " `coachNameStudents`=?,`coachMoNoStudents`=?,`addressStudents`=?,`imageStudents`=?"
                sqlQuery += " WHERE idStudents = ?";
                params.push(thisModal.idStudents);
                callback(null, null);
              }
            }, req
          );
        } else {
          console.log(":::::::::::::::", thisModal.isFromEvent);

          if (parseInt(thisModal.isFromEvent) > 0) {
            console.log(":::::::::HERE::::::");
            sqlQuery = "CALL studentAndEventEntry('" +
              thisModal.firstNameStudents + "','" +
              thisModal.middleNameStudents + "','" +
              thisModal.lastNameStudents + "','" +
              thisModal.emailStudents + "'," +
              thisModal.adharNoStudents + "," +
              thisModal.mobileNoStudents + ",'" +
              thisModal.genderStudents + "','" +
              thisModal.dobStudents + "','" +
              thisModal.coachNameStudents + "'," +
              thisModal.coachMoNoStudents + ",'" +
              thisModal.addressStudents + "','" +
              thisModal.imageStudents + "'," +
              thisModal.eventId + "," +
              thisModal.ageGroup
              + ")";
          }
          else {
            console.log(":::::::::HERE2::::::");
            sqlQuery = " INSERT INTO `students`"
            sqlQuery += " (`firstNameStudents`, `middleNameStudents`, `lastNameStudents`, `emailStudents`, `adharNoStudents`, `mobileNoStudents`, `genderStudents`, `dobStudents`, `coachNameStudents`, `coachMoNoStudents`, `addressStudents`, `imageStudents`)"
            sqlQuery += " VALUES (?,?,?,?,?,?,?,?,?,?,?,?);";
          }


          console.log("insert ::: ", sqlQuery, [thisModal.isFromEvent]);

          callback(null, null);
        }
      },
      function (error, callback) {
        if (error) {
          callback(error, null);
        } else {
          dbservice.executeSql(sqlQuery, params, function (err, res) {
            callback(err, res);
          }, req);
        }
      }
    ],
    function (err, res) {
      if (err) {
        result(err, null);
      } else {
        result(null, res);
      }
    }
  );
}


function insertStudentAndEvent(req, result) {
  // console.log("insertStudentAndEvent event in service :: ", [req.body]);

  let sqlQuery = "";  
  if(req.body.idStudents && parseInt(req.body.idStudents) > 0 ){} else{req.body.idStudents = 0;}
  if (parseInt(req.body.isFromEvent) <= 0) { req.body.eventId = 0;}    
  console.log("insertStudentAndEvent event in service :: ", [req.body]);
    sqlQuery = "CALL studentAndEventEntry('" +
      req.body.firstNameStudents + "','" +
      req.body.middleNameStudents + "','" +
      req.body.lastNameStudents + "','" +
      req.body.emailStudents + "'," +
      req.body.adharNoStudents + "," +
      req.body.mobileNoStudents + ",'" +
      req.body.genderStudents + "','" +
      req.body.dobStudents + "','" +
      req.body.coachNameStudents + "'," +
      req.body.coachMoNoStudents + ",'" +
      req.body.addressStudents + "','" +
      req.body.imageStudents + "'," +
      req.body.eventId + "," +
      req.body.ageGroup+ "," +
      req.body.idStudents
      + ")";
    dbservice.executeSql(sqlQuery, [], function (err, res) {
      console.log("check log file");
      
      
      
      result(err, res);
      
    }, req);
}

function getstudentByAdhar(req,result){
  if(req.query.AdharStudent){
    let params = [req.query.AdharStudent];
    let sqlQuery = "SELECT * FROM `students` WHERE `adharNoStudents` = ?";
    dbservice.executeSql(sqlQuery, params, function(err, res) {
      if (err) {
        result(err, null);
      } else {
        result(null, res);
      }
    },req);
  }
}