let dbservice = require("../database/db.service");
let waterfall = require("async-waterfall");

let sliderService = {
  saveSliderImages: insertSliderImages,
  getSliderData: get,
  postSliderData: post
};

module.exports = sliderService;

function get(req, result) {
  let sqlQuery =
    "SELECT * FROM slidersection WHERE isActiveSliderSection = 1 ORDER BY orderSliderSection;";
  let params = [];
  dbservice.executeSql(sqlQuery, params, function(err, res) {
    if (err) {
      result(err, null);
    } else {
      result(null, res);
    }
  },req);
}

function post(req, result) {
  let sqlQuery = "";
  let sliderHomepageModel = require("../../models/homepage/slider.modal");
  sliderHomepageModel.body = req.body;
  var thisModal = sliderHomepageModel.body;
  let params = [
    thisModal.captionSliderSection,
    thisModal.titleSliderSection,
    thisModal.isActiveSliderSection,
    thisModal.employeeId,
    thisModal.orderSliderSection
  ];
  waterfall(
    [
      function(callback) {
        if (thisModal.idSliderSection && thisModal.idSliderSection > 0) {
          dbservice.executeSql(
            "SELECT * FROM `slidersection` WHERE `idSliderSection` = ?",
            [thisModal.idSliderSection],
            function(err, res) {
              if (err) {
                callback(null, err);
              } else {
                sqlQuery =
                  "update slidersection set captionSliderSection = ? , titleSliderSection = ? , isActiveSliderSection = ? , employeeId = ? , orderSliderSection = ? WHERE idSliderSection = ?";
                params.push(thisModal.idSliderSection);
                callback(null, null);
              }
            },req
          );
        } else {
          sqlQuery =
            "INSERT INTO slidersection (captionSliderSection , titleSliderSection , isActiveSliderSection , employeeId , orderSliderSection) VALUES(?,?,?,?)";
          callback(null, null);
        }
      },
      function(error, callback) {
        if (error) {
          callback(error, null);
        } else {
          dbservice.executeSql(sqlQuery, params, function(err, res) {
            callback(err, res);
          },req);
        }
      }
    ],
    function(err, res) {
      if (err) {
        result(err, null);
      } else {
        result(null, res);
      }
    }
  );
}

function insertSliderImages(req, response, result) {
  let uploaderModel = require("../../models/uploader.modal");
  var thisModal = (uploaderModel.body = req.body);
  let params = [thisModal.isActive, thisModal.employeeId];
  let sqlQuery =
    "INSERT INTO slidersection (isActiveSliderSection,employeeId, urlSliderSection) ";
  sqlQuery += "VALUES(?,?,?)";
  dbservice.execFileUpload(sqlQuery, params, req.files, response, function(
    err,
    res
  ) {
    result(err, res);
  });
}
